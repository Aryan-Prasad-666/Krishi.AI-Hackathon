{% extends "base.html" %}

{% block title %}Krishi.ai - Crop Planning{% endblock %}

{% block extra_css %}
<style>
    .crop-planning-section {
        padding: 80px 0;
        background: url('https://images.pexels.com/photos/2886937/pexels-photo-2886937.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2') no-repeat center center;
        background-size: cover;
        background-attachment: fixed;
        min-height: 100vh;
        text-align: center;
        position: relative;
        z-index: 1;
    }

    .crop-planning-section::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.7);
        z-index: -1;
    }

    .crop-planning-section h1 {
        font-size: 38px;
        font-weight: 700;
        margin-bottom: 20px;
        color: #1a3c24;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .crop-planning-section p.lead {
        font-size: 18px;
        line-height: 1.6;
        max-width: 700px;
        margin: 0 auto 40px;
        color: #3a2b1f;
    }

    .form-container {
        max-width: 600px;
        margin: 0 auto 40px;
        padding: 20px;
        background: #fff;
        border-radius: 15px;
        border: 1px solid #e8b923;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s ease;
    }

    .form-container:hover {
        transform: translateY(-5px);
    }

    .form-container form {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    .form-container label {
        font-size: 16px;
        font-weight: 600;
        color: #1a3c24;
        text-align: left;
    }

    .form-container input, .form-container select {
        padding: 12px;
        font-size: 16px;
        border: 1px solid #ccc;
        border-radius: 8px;
        width: 100%;
        box-sizing: border-box;
        transition: border-color 0.3s ease;
    }

    .form-container input:focus, .form-container select:focus {
        outline: none;
        border-color: #d4a017;
    }

    .form-container button {
        background: linear-gradient(45deg, #e8b923, #d4a017);
        color: #1a3c24;
        padding: 12px;
        font-size: 18px;
        font-weight: 700;
        border: none;
        border-radius: 50px;
        cursor: pointer;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .form-container button:hover:not(:disabled) {
        transform: translateY(-3px);
        box-shadow: 0 6px 20px rgba(232, 185, 35, 0.6);
    }

    .form-container button:disabled {
        background: #ccc;
        cursor: not-allowed;
    }

    .results-container {
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
    }

    .results-container h2 {
        font-size: 28px;
        font-weight: 700;
        color: #1a3c24;
        margin-bottom: 20px;
    }

    .final-plan {
        background: #fff;
        padding: 30px;
        border-radius: 15px;
        border: 1px solid #e8b923;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        margin-bottom: 40px;
        transition: transform 0.3s ease;
    }

    .final-plan:hover {
        transform: translateY(-5px);
    }

    .final-plan p {
        font-size: 16px;
        line-height: 1.6;
        color: #3a2b1f;
    }

    .history-container {
        margin-top: 40px;
    }

    .history-item {
        background: #fff;
        padding: 20px;
        border-radius: 15px;
        border: 1px solid #e8b923;
        margin-bottom: 20px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s ease;
    }

    .history-item:hover {
        transform: translateY(-5px);
    }

    .history-item p {
        font-size: 16px;
        line-height: 1.6;
        color: #3a2b1f;
        margin: 0;
    }

    .error-message {
        color: #d32f2f;
        font-size: 16px;
        margin-bottom: 20px;
        background: rgba(255, 255, 255, 0.9);
        padding: 10px;
        border-radius: 8px;
        border: 1px solid #d32f2f;
        max-width: 600px;
        margin: 0 auto;
        text-align: center;
    }

    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 9999;
    }

    .spinner {
        border: 8px solid #f3f3f3;
        border-top: 8px solid #e8b923;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @media (max-width: 768px) {
        .crop-planning-section {
            padding: 40px 15px;
        }

        .crop-planning-section h1 {
            font-size: 32px;
        }

        .crop-planning-section p.lead {
            font-size: 16px;
        }

        .form-container {
            margin: 0 15px;
            padding: 15px;
        }

        .results-container {
            padding: 15px;
        }

        .final-plan, .history-item {
            padding: 15px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
</div>

<div class="crop-planning-section">
    <div class="container mx-auto">
        <h1 data-translate="crop_planning_title">Crop Planning</h1>
        <p class="lead" data-translate="crop_planning_description">Enter your location, plan duration, and preferred language to get a personalized crop plan for your farm.</p>

        <div class="form-container">
            <form id="cropPlanningForm">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="location">Location</label>
                        <input type="text" id="location" name="location" required>
                    </div>
                    <div>
                        <label for="plan_duration">Plan Duration (months)</label>
                        <input type="number" id="plan_duration" name="plan_duration" min="1" step="1" required>
                    </div>
                    <div>
                        <label for="language">Language</label>
                        <select id="language" name="language" required>
                            <option value="" disabled selected>Select language</option>
                            <option value="English">English</option>
                            <option value="Hindi">Hindi</option>
                            <option value="Kannada">Kannada</option>
                            <option value="Malayalam">Malayalam</option>
                        </select>
                    </div>
                </div>
                <button type="submit" id="submitBtn">Generate Crop Plan</button>
            </form>
        </div>

        <div id="errorMessage" class="error-message" style="display: none;"></div>

        <div id="resultsContainer" class="results-container" style="display: none;">
            <h2 data-translate="final_plan_title">Final Crop Plan</h2>
            <div class="final-plan">
                <p id="finalPlan"></p>
            </div>

            <div class="history-container">
                <h2 data-translate="history_title">Planning History</h2>
                <div id="historyList"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Form handling
    const form = document.getElementById('cropPlanningForm');
    const submitBtn = document.getElementById('submitBtn');
    const loadingOverlay = document.getElementById('loadingOverlay');
    const errorMessage = document.getElementById('errorMessage');
    const resultsContainer = document.getElementById('resultsContainer');
    const historyList = document.getElementById('historyList');
    const finalPlan = document.getElementById('finalPlan');

    // Show error
    function showError(message) {
        console.error('Error:', message);
        errorMessage.textContent = message;
        errorMessage.style.display = 'block';
        resultsContainer.style.display = 'none';
        loadingOverlay.style.display = 'none';
        submitBtn.disabled = false;
    }

    // Generate plan
    async function generatePlan(event) {
        event.preventDefault();
        errorMessage.style.display = 'none';
        resultsContainer.style.display = 'none';
        loadingOverlay.style.display = 'flex';
        submitBtn.disabled = true;

        const location = document.getElementById("location").value;
        const plan_duration = document.getElementById("plan_duration").value;
        const language = document.getElementById("language").value;

        try {
            const response = await fetch('/crop_planning_data', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ location, plan_duration, language })
            });

            if (!response.ok) {
                throw new Error("Server error: " + response.status);
            }

            const data = await response.json();
            console.log("Response:", data);

            // Fill results
            historyList.innerHTML = "";
            if (data.history && data.history.length > 0) {
                data.history.forEach(item => {
                    const div = document.createElement("div");
                    div.className = "history-item";
                    const p = document.createElement("p");
                    p.textContent = item;
                    div.appendChild(p);
                    historyList.appendChild(div);
                });
            }
            finalPlan.textContent = data.final_plan || "No plan generated.";

            resultsContainer.style.display = 'block';
            loadingOverlay.style.display = 'none';
            submitBtn.disabled = false;
        } catch (error) {
            showError("Failed to fetch crop plan. " + error.message);
        }
    }

    // Attach handler
    form.addEventListener("submit", generatePlan);

    // Debug
    document.addEventListener('DOMContentLoaded', () => {
        loadingOverlay.style.display = 'none';
        console.log('Page loaded, loader hidden');
    });
</script>
{% endblock %}